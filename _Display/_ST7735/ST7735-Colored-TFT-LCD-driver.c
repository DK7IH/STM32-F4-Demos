///////////////////////////////////////////////////////////////////
//            ST7735 Color LCD DEMO with STM32F4                 //
///////////////////////////////////////////////////////////////////
//  Mikrocontroller:  STM32F4                                    //
//                                                               //
//  Compiler:         ARM GCC TOOLCHAIN                          //
//  Author:           Peter Rachow (DK7IH)                       //
//                    JUL 2021                                   // 
///////////////////////////////////////////////////////////////////
/*                                                               // 
 Datasheet:                                                      //  
 http://displayfuture.com/Display/datasheet/controller/ST7735.pdf//
*/                                                               //
///////////////////////////////////////////////////////////////////
//                                                               //
//SOFTWARE                                                       //
//                                                               //
// This Demo ist text-oriented. There are no graphical functions // 
// included. The code can be used to write text data in 65536    //
// different colors to the LCD's screen.                         //
//                                                               //
// An 8x12 pixel font is integrated.                             //
//                                                               //
// Font display can be indivudually scaled by determing "strech" //
// factors for x and y seperately. So a wide variety of text     //
// layouts can be achived.                                       //
//                                                               //
///////////////////////////////////////////////////////////////////


#include "stm32f4xx.h"
#include <stdlib.h>

//SPI LCD defines
#define LCD_GPIO GPIOA
#define DATA   0 //green (marking "SDA")
#define CLK    1 //blue  (marking "SCK")
#define DC_AO  2 //white
#define RST    3 //gray
#define CS     4 //yellow

//LCD ST7735 contants
#define ST7735_NOP     0x00
#define ST7735_SWRESET 0x01
#define ST7735_RDDID   0x04
#define ST7735_RDDST   0x09
#define ST7735_SLPIN   0x10
#define ST7735_SLPOUT  0x11
#define ST7735_PTLON   0x12
#define ST7735_NORON   0x13
#define ST7735_INVOFF  0x20
#define ST7735_INVON   0x21
#define ST7735_DISPOFF 0x28
#define ST7735_DISPON  0x29
#define ST7735_CASET   0x2A
#define ST7735_RASET   0x2B
#define ST7735_RAMWR   0x2C
#define ST7735_RAMRD   0x2E
#define ST7735_PTLAR   0x30
#define ST7735_COLMOD  0x3A
#define ST7735_MADCTL  0x36
#define ST7735_FRMCTR1 0xB1
#define ST7735_FRMCTR2 0xB2
#define ST7735_FRMCTR3 0xB3
#define ST7735_INVCTR  0xB4
#define ST7735_DISSET5 0xB6
#define ST7735_PWCTR1  0xC0
#define ST7735_PWCTR2  0xC1
#define ST7735_PWCTR3  0xC2
#define ST7735_PWCTR4  0xC3
#define ST7735_PWCTR5  0xC4
#define ST7735_VMCTR1  0xC5
#define ST7735_RDID1   0xDA
#define ST7735_RDID2   0xDB
#define ST7735_RDID3   0xDC
#define ST7735_RDID4   0xDD
#define ST7735_PWCTR6  0xFC
#define ST7735_GMCTRP1 0xE0
#define ST7735_GMCTRN1 0xE1
//Some sample colors
//USeful website http://www.barth-dev.de/online/rgb565-color-picker/
#define WHITE        0xFFFF
#define BLACK        0x0000
#define GRAY         0x94B2
#define LIGHTGRAY    0xC5D7

#define LIGHTBLUE    0x755C
#define BLUE         0x3C19
#define DARKBLUE     0x0A73

#define LIGHTRED     0xFA60 //0xE882 // 0xEB2D //0xDAAB
#define RED          0xF803 //0xB1A7
#define DARKRED      0x80C3

#define LIGHTGREEN   0x27E0 //0x6E84
#define GREEN        0x07EA //0x6505
#define DARKGREEN    0x3B04

#define LIGHTVIOLET  0xAC19
#define LIGHTVIOLET2 0x9BD9
#define VIOLET       0x71B6
#define DARKVIOLET   0x48AF

#define DARKYELLOW   0xB483
#define YELLOW       0xFF00 //0xE746  0xFD40
#define YELLOW2      0xFEC0
#define LIGHTYELLOW  0xF7E0 //0xF752  //0xF7AF

#define LIGHTBROWN   0xF64F
#define BROWN        0x9323
#define DARKBROWN    0x6222

//Some sample colors
//Font
#define FONTWIDTH 8 
#define FONTHEIGHT 12

#define CHAROFFSET 0x20
const unsigned char xchar[][FONTHEIGHT] ={
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},	// 0x20
{0x00,0x0C,0x1E,0x1E,0x1E,0x0C,0x0C,0x00,0x0C,0x0C,0x00,0x00},	// 0x21
{0x00,0x66,0x66,0x66,0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x00},	// 0x22
{0x00,0x36,0x36,0x7F,0x36,0x36,0x36,0x7F,0x36,0x36,0x00,0x00},	// 0x23
{0x0C,0x0C,0x3E,0x03,0x03,0x1E,0x30,0x30,0x1F,0x0C,0x0C,0x00},	// 0x24
{0x00,0x00,0x00,0x23,0x33,0x18,0x0C,0x06,0x33,0x31,0x00,0x00},	// 0x25
{0x00,0x0E,0x1B,0x1B,0x0E,0x5F,0x7B,0x33,0x3B,0x6E,0x00,0x00},	// 0x26
{0x00,0x0C,0x0C,0x0C,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00},	// 0x27
{0x00,0x30,0x18,0x0C,0x06,0x06,0x06,0x0C,0x18,0x30,0x00,0x00},	// 0x28
{0x00,0x06,0x0C,0x18,0x30,0x30,0x30,0x18,0x0C,0x06,0x00,0x00},	// 0x29
{0x00,0x00,0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00,0x00,0x00},	// 0x2A
{0x00,0x00,0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00,0x00,0x00},	// 0x2B
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1C,0x1C,0x06,0x00},	// 0x2C
{0x00,0x00,0x00,0x00,0x00,0x7F,0x00,0x00,0x00,0x00,0x00,0x00},	// 0x2D
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1C,0x1C,0x00,0x00},	// 0x2E
{0x00,0x00,0x40,0x60,0x30,0x18,0x0C,0x06,0x03,0x01,0x00,0x00},	// 0x2F
{0x00,0x3E,0x63,0x63,0x63,0x6B,0x63,0x63,0x63,0x3E,0x00,0x00},	// 0x30
{0x00,0x08,0x0C,0x0F,0x0C,0x0C,0x0C,0x0C,0x0C,0x3F,0x00,0x00},	// 0x31
{0x00,0x1E,0x33,0x33,0x30,0x18,0x0C,0x06,0x33,0x3F,0x00,0x00},	// 0x32
{0x00,0x1E,0x33,0x30,0x30,0x1C,0x30,0x30,0x33,0x1E,0x00,0x00},	// 0x33
{0x00,0x30,0x38,0x3C,0x36,0x33,0x7F,0x30,0x30,0x78,0x00,0x00},	// 0x34
{0x00,0x3F,0x03,0x03,0x03,0x1F,0x30,0x30,0x33,0x1E,0x00,0x00},	// 0x35
{0x00,0x1C,0x06,0x03,0x03,0x1F,0x33,0x33,0x33,0x1E,0x00,0x00},	// 0x36
{0x00,0x7F,0x63,0x63,0x60,0x30,0x18,0x0C,0x0C,0x0C,0x00,0x00},	// 0x37
{0x00,0x1E,0x33,0x33,0x33,0x1E,0x33,0x33,0x33,0x1E,0x00,0x00},	// 0x38
{0x00,0x1E,0x33,0x33,0x33,0x3E,0x18,0x18,0x0C,0x0E,0x00,0x00},	// 0x39
{0x00,0x00,0x00,0x1C,0x1C,0x00,0x00,0x1C,0x1C,0x00,0x00,0x00},	// 0x3A
{0x00,0x00,0x00,0x1C,0x1C,0x00,0x00,0x1C,0x1C,0x18,0x0C,0x00},	// 0x3B
{0x00,0x30,0x18,0x0C,0x06,0x03,0x06,0x0C,0x18,0x30,0x00,0x00},	// 0x3C
{0x00,0x00,0x00,0x00,0x7E,0x00,0x7E,0x00,0x00,0x00,0x00,0x00},	// 0x3D
{0x00,0x06,0x0C,0x18,0x30,0x60,0x30,0x18,0x0C,0x06,0x00,0x00},	// 0x3E
{0x00,0x1E,0x33,0x30,0x18,0x0C,0x0C,0x00,0x0C,0x0C,0x00,0x00},	// 0x3F
{0x00,0x3E,0x63,0x63,0x7B,0x7B,0x7B,0x03,0x03,0x3E,0x00,0x00},	// 0x40
{0x00,0x0C,0x1E,0x33,0x33,0x33,0x3F,0x33,0x33,0x33,0x00,0x00},	// 0x41
{0x00,0x3F,0x66,0x66,0x66,0x3E,0x66,0x66,0x66,0x3F,0x00,0x00},	// 0x42
{0x00,0x3C,0x66,0x63,0x03,0x03,0x03,0x63,0x66,0x3C,0x00,0x00},	// 0x43
{0x00,0x1F,0x36,0x66,0x66,0x66,0x66,0x66,0x36,0x1F,0x00,0x00},	// 0x44
{0x00,0x7F,0x46,0x06,0x26,0x3E,0x26,0x06,0x46,0x7F,0x00,0x00},	// 0x45
{0x00,0x7F,0x66,0x46,0x26,0x3E,0x26,0x06,0x06,0x0F,0x00,0x00},	// 0x46
{0x00,0x3C,0x66,0x63,0x03,0x03,0x73,0x63,0x66,0x7C,0x00,0x00},	// 0x47
{0x00,0x33,0x33,0x33,0x33,0x3F,0x33,0x33,0x33,0x33,0x00,0x00},	// 0x48
{0x00,0x1E,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x1E,0x00,0x00},	// 0x49
{0x00,0x78,0x30,0x30,0x30,0x30,0x33,0x33,0x33,0x1E,0x00,0x00},	// 0x4A
{0x00,0x67,0x66,0x36,0x36,0x1E,0x36,0x36,0x66,0x67,0x00,0x00},	// 0x4B
{0x00,0x0F,0x06,0x06,0x06,0x06,0x46,0x66,0x66,0x7F,0x00,0x00},	// 0x4C
{0x00,0x63,0x77,0x7F,0x7F,0x6B,0x63,0x63,0x63,0x63,0x00,0x00},	// 0x4D
{0x00,0x63,0x63,0x67,0x6F,0x7F,0x7B,0x73,0x63,0x63,0x00,0x00},	// 0x4E
{0x00,0x1C,0x36,0x63,0x63,0x63,0x63,0x63,0x36,0x1C,0x00,0x00},	// 0x4F
{0x00,0x3F,0x66,0x66,0x66,0x3E,0x06,0x06,0x06,0x0F,0x00,0x00},	// 0x50
{0x00,0x1C,0x36,0x63,0x63,0x63,0x73,0x7B,0x3E,0x30,0x78,0x00},	// 0x51
{0x00,0x3F,0x66,0x66,0x66,0x3E,0x36,0x66,0x66,0x67,0x00,0x00},	// 0x52
{0x00,0x1E,0x33,0x33,0x03,0x0E,0x18,0x33,0x33,0x1E,0x00,0x00},	// 0x53
{0x00,0x3F,0x2D,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x1E,0x00,0x00},	// 0x54
{0x00,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x1E,0x00,0x00},	// 0x55
{0x00,0x33,0x33,0x33,0x33,0x33,0x33,0x33,0x1E,0x0C,0x00,0x00},	// 0x56
{0x00,0x63,0x63,0x63,0x63,0x6B,0x6B,0x36,0x36,0x36,0x00,0x00},	// 0x57
{0x00,0x33,0x33,0x33,0x1E,0x0C,0x1E,0x33,0x33,0x33,0x00,0x00},	// 0x58
{0x00,0x33,0x33,0x33,0x33,0x1E,0x0C,0x0C,0x0C,0x1E,0x00,0x00},	// 0x59
{0x00,0x7F,0x73,0x19,0x18,0x0C,0x06,0x46,0x63,0x7F,0x00,0x00},	// 0x5A
{0x00,0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00,0x00},	// 0x5B
{0x00,0x00,0x01,0x03,0x06,0x0C,0x18,0x30,0x60,0x40,0x00,0x00},	// 0x5C
{0x00,0x3C,0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x3C,0x00,0x00},	// 0x5D
{0x08,0x1C,0x36,0x63,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},	// 0x5E
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00},	// 0x5F
{0x0C,0x0C,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},	// 0x60
{0x00,0x00,0x00,0x00,0x1E,0x30,0x3E,0x33,0x33,0x6E,0x00,0x00},	// 0x61
{0x00,0x07,0x06,0x06,0x3E,0x66,0x66,0x66,0x66,0x3B,0x00,0x00},	// 0x62
{0x00,0x00,0x00,0x00,0x1E,0x33,0x03,0x03,0x33,0x1E,0x00,0x00},	// 0x63
{0x00,0x38,0x30,0x30,0x3E,0x33,0x33,0x33,0x33,0x6E,0x00,0x00},	// 0x64
{0x00,0x00,0x00,0x00,0x1E,0x33,0x3F,0x03,0x33,0x1E,0x00,0x00},	// 0x65
{0x00,0x1C,0x36,0x06,0x06,0x1F,0x06,0x06,0x06,0x0F,0x00,0x00},	// 0x66
{0x00,0x00,0x00,0x00,0x6E,0x33,0x33,0x33,0x3E,0x30,0x33,0x1E},	// 0x67
{0x00,0x07,0x06,0x06,0x36,0x6E,0x66,0x66,0x66,0x67,0x00,0x00},	// 0x68
{0x00,0x18,0x18,0x00,0x1E,0x18,0x18,0x18,0x18,0x7E,0x00,0x00},	// 0x69
{0x00,0x30,0x30,0x00,0x3C,0x30,0x30,0x30,0x30,0x33,0x33,0x1E},	// 0x6A
{0x00,0x07,0x06,0x06,0x66,0x36,0x1E,0x36,0x66,0x67,0x00,0x00},	// 0x6B
{0x00,0x1E,0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x7E,0x00,0x00},	// 0x6C
{0x00,0x00,0x00,0x00,0x3F,0x6B,0x6B,0x6B,0x6B,0x63,0x00,0x00},	// 0x6D
{0x00,0x00,0x00,0x00,0x1F,0x33,0x33,0x33,0x33,0x33,0x00,0x00},	// 0x6E
{0x00,0x00,0x00,0x00,0x1E,0x33,0x33,0x33,0x33,0x1E,0x00,0x00},	// 0x6F
{0x00,0x00,0x00,0x00,0x3B,0x66,0x66,0x66,0x66,0x3E,0x06,0x0F},	// 0x70
{0x00,0x00,0x00,0x00,0x6E,0x33,0x33,0x33,0x33,0x3E,0x30,0x78},	// 0x71
{0x00,0x00,0x00,0x00,0x37,0x76,0x6E,0x06,0x06,0x0F,0x00,0x00},	// 0x72
{0x00,0x00,0x00,0x00,0x1E,0x33,0x06,0x18,0x33,0x1E,0x00,0x00},	// 0x73
{0x00,0x00,0x04,0x06,0x3F,0x06,0x06,0x06,0x36,0x1C,0x00,0x00},	// 0x74
{0x00,0x00,0x00,0x00,0x33,0x33,0x33,0x33,0x33,0x6E,0x00,0x00},	// 0x75
{0x00,0x00,0x00,0x00,0x33,0x33,0x33,0x33,0x1E,0x0C,0x00,0x00},	// 0x76
{0x00,0x00,0x00,0x00,0x63,0x63,0x6B,0x6B,0x36,0x36,0x00,0x00},	// 0x77
{0x00,0x00,0x00,0x00,0x63,0x36,0x1C,0x1C,0x36,0x63,0x00,0x00},	// 0x78
{0x00,0x00,0x00,0x00,0x66,0x66,0x66,0x66,0x3C,0x30,0x18,0x0F},	// 0x79
{0x00,0x00,0x00,0x00,0x3F,0x31,0x18,0x06,0x23,0x3F,0x00,0x00},	// 0x7A
{0x00,0x38,0x0C,0x0C,0x06,0x03,0x06,0x0C,0x0C,0x38,0x00,0x00},	// 0x7B
{0x00,0x18,0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x18,0x00,0x00},	// 0x7C
{0x00,0x07,0x0C,0x0C,0x18,0x30,0x18,0x0C,0x0C,0x07,0x00,0x00},	// 0x7D
{0x00,0xCE,0x5B,0x73,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},	// 0x7E
{0x00,0x00,0x00,0x08,0x1C,0x36,0x63,0x63,0x7F,0x00,0x00,0x00},	// 0x7F
{0x00,0x1E,0x33,0x33,0x03,0x03,0x03,0x33,0x33,0x1E,0x0C,0x06},	// 0x80
{0x00,0x00,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00},	// 0x81 S-Meter bar block
{0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10},	// 0x82 |
{0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0x00},	// 0x83 -
{0x10,0x10,0x10,0x10,0x10,0x10,0xF0,0x00,0x00,0x00,0x00,0x00},	// 0x84 '-
{0x10,0x10,0x10,0x10,0x10,0x10,0x1F,0x00,0x00,0x00,0x00,0x00},	// 0x85 -'
{0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0x10,0x10,0x10,0x10,0x10},	// 0x86 ;-
{0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0x10,0x10,0x10,0x10,0x10},	// 0x87 -;
{0x00,0x08,0x14,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},	// 0x88 ° 
};
////////////////
//Declarations//
////////////////

//MISC
int main(void);
static void delay (unsigned int);

//ST7735 LCD
void lcd_reset(void);                                    //Reset LCD
void lcd_write_command(int);                             //Send a command to LCD
void lcd_write_data(int);                                //Send data to LCD
void lcd_setwindow(int, int, int, int);                  //Define output window on LCD
void lcd_setpixel(int, int, unsigned int);               //Set 1 Pixel
void lcd_cls(unsigned int);                              //Clear LCD
unsigned int lcd_16bit_color(int, int, int);             //Define color value (int) from red, green and blue
void lcd_putchar(int, int, unsigned char, unsigned int, unsigned int, int, int); //Write one char to LCD (double size, variable height)
void lcd_putstring(int, int, char*, unsigned int, unsigned int, int, int);       //Write \0 terminated string to LCD (double size, variable height)
int lcd_putnumber(int, int, long, int, int, int, int, int);                     //Write a number (int or long) to LCD (double size, variable height)

//STRING FUNCTIONS
int int2asc(long, int, char*, int);                                     //Convert an int or long number to a string
int strlen(char *);                                                     //Calculate length of string 

/////////////////////////////
 //  Cheap and dirty delay  //
/////////////////////////////
static void delay (unsigned int time) 
{
    for (unsigned int i = 0; i < time; i++)
    {
        for (volatile unsigned int j = 0; j < 2000; j++);
    }    
}
  ///////////////////////
 //       L C D       //
///////////////////////    
//Perform hardware reset to LCD
void lcd_reset(void)
{
	LCD_GPIO->ODR |= (1 << RST);  
	delay(100);
	LCD_GPIO->ODR &= ~((1 << RST));  
	delay(100);
	LCD_GPIO->ODR |= (1 << RST);  
	delay(100);
}	

//Write command to LCD
void lcd_write_command(int cmd)
{
	int t1;
	
	LCD_GPIO->ODR &= ~(1 << DC_AO);  //Command
    LCD_GPIO->ODR &= ~(1 << CS);     //(1 << CS)=0
	
	for(t1 = 7; t1 >= 0; t1--)
    {
	    LCD_GPIO->ODR &= ~(1 << CLK);  //SCL=0	
	    if(cmd & (1 << t1))
	    {
		    LCD_GPIO->ODR |= (1 << DATA);
	    }
	    else
	    {
		    LCD_GPIO->ODR &= ~(1 << DATA); 
	    }
	    LCD_GPIO->ODR |= (1 << CLK);  //SCL=1		
	}	
	LCD_GPIO->ODR |= (1 << CS);        //(1 << CS)=1
}	

//Write data to LCD
void lcd_write_data(int dvalue)
{
	int t1;
	
	LCD_GPIO->ODR |= (1 << DC_AO);     //Data
	LCD_GPIO->ODR &= ~(1 << CS);     //(1 << CS)=0
	for(t1 = 7; t1 >= 0; t1--)
    {
	    LCD_GPIO->ODR &= ~(1 << CLK);  //SCL=0	
	    if(dvalue & (1 << t1))
	    {
		    LCD_GPIO->ODR |= (1 << DATA);
	    }
	    else
	    {
		    LCD_GPIO->ODR &= ~(1 << DATA); 
	    }
	    LCD_GPIO->ODR |= (1 << CLK);  //SCL=1		
	}	
	LCD_GPIO->ODR |= (1 << CS);        //(1 << CS)=1
}	


//Init LCD to vertical alignement and 16-bit color mode
void lcd_init(void)
{

	lcd_write_command(ST7735_SWRESET); // software reset
	delay(5);

	lcd_write_command(ST7735_SLPOUT);  // out of sleep mode
	delay(5);

	lcd_write_command(ST7735_COLMOD);  // set color mode
	lcd_write_data(0x05);              // 16-bit color
	delay(10);

	lcd_write_command(ST7735_FRMCTR1); // frame rate control
	lcd_write_data(0x00);              // fastest refresh
	lcd_write_data(0x06);              // 6 lines front porch
	lcd_write_data(0x03);              // 3 lines backporch
	delay(1);

	lcd_write_command(ST7735_MADCTL);  // memory access control (directions)
	lcd_write_data(0xC8);              // row address/col address, bottom to top refresh

	lcd_write_command(ST7735_DISSET5); // display settings #5
	lcd_write_data(0x15);              // 1 clock cycle nonoverlap, 2 cycle gate rise, 3 cycle oscil. equalize
	lcd_write_data(0x02);              // fix on VTL

	lcd_write_command(ST7735_INVCTR);  // display inversion control
	lcd_write_data(0x0);               // line inversion

	lcd_write_command(ST7735_GMCTRP1);
	lcd_write_data(0x09);
	lcd_write_data(0x16);
	lcd_write_data(0x09);
	lcd_write_data(0x20);
	lcd_write_data(0x21);
	lcd_write_data(0x1B);
	lcd_write_data(0x13);
	lcd_write_data(0x19);
	lcd_write_data(0x17);
	lcd_write_data(0x15);
	lcd_write_data(0x1E);
	lcd_write_data(0x2B);
	lcd_write_data(0x04);
	lcd_write_data(0x05);
	lcd_write_data(0x02);
	lcd_write_data(0x0E);

	lcd_write_command(ST7735_GMCTRN1);
	lcd_write_data(0x0B);
	lcd_write_data(0x14);
	lcd_write_data(0x08);
	lcd_write_data(0x1E);
	lcd_write_data(0x22);
	lcd_write_data(0x1D);
	lcd_write_data(0x18);
	lcd_write_data(0x1E);
	lcd_write_data(0x1B);
	lcd_write_data(0x1A);
	lcd_write_data(0x24);
	lcd_write_data(0x2B);
	lcd_write_data(0x06);
	lcd_write_data(0x06);
	lcd_write_data(0x02);
	lcd_write_data(0x0F);
	delay(10);
	
	lcd_write_command(ST7735_NORON);   // Normal display on
	delay(10);

	lcd_write_command(ST7735_DISPON);  //Display ON
}	

//Define window area for next graphic operation
void lcd_setwindow(int x0, int y0, int x1, int y1)
{
	lcd_write_command(ST7735_CASET);   //Coloumn address set
	lcd_write_data(0x00);
	lcd_write_data(x0);          
	lcd_write_data(0x00);
	lcd_write_data(x1);          

	lcd_write_command(ST7735_RASET);   //Row address set
	lcd_write_data(0x00);
	lcd_write_data(y0);        
	lcd_write_data(0x00);
	lcd_write_data(y1);        
}

//Set a pixel (Not used, just for academic purposes!)
void lcd_setpixel(int x, int y, unsigned int color)
{
	lcd_setwindow(x, y, x, y);
	lcd_write_command(ST7735_RAMWR);		// RAM access set
	lcd_write_data(color >> 8);
	lcd_write_data(color);
}

//Clear full LCD with background color
void lcd_cls0(unsigned int bgcolor)
{
	int t1;
	lcd_setwindow(0, 0, 132, 132);
	lcd_write_command(ST7735_RAMWR);		// RAM access set
		
    for(t1 = 0; t1 <= 17424; t1++)
    {
		lcd_write_data(bgcolor >> 8);
	    lcd_write_data(bgcolor);
	}    
}	

//Clear part of LCD with background color
void lcd_cls1(int x0, int y0, int x1, int y1, unsigned int bgcolor)
{
	int t1, sz = (x1 - x0) * (y1 - y0);
	lcd_setwindow(x0, y0, x1, y1);
	lcd_write_command(ST7735_RAMWR);		// RAM access set
		
    for(t1 = 0; t1 <= sz; t1++)
    {
		lcd_write_data(bgcolor >> 8);
	    lcd_write_data(bgcolor);
	}    
}	

//Print one character to given coordinates to the screen
//sx and sy define "stretch factor"
void lcd_putchar(int x0, int y0, unsigned char ch0, unsigned int fcol, unsigned int bcol, int sx, int sy)
{
	int x, y, t1, t2;
	unsigned char ch;
	
    lcd_setwindow(x0 + 2, y0 + 2, x0 + FONTWIDTH * sx + 1, y0 + FONTHEIGHT * sy);
	lcd_write_command(ST7735_RAMWR);
	
	for(y = 0; y < FONTHEIGHT - 1; y++)
	{
		ch = xchar[ch0 - CHAROFFSET][y]; 
	    for(t1 = 0; t1 < sy; t1++)
	    {
	        for(x = 0; x < FONTWIDTH; x++)
	        {
		        if((1 << x) & ch)
		        {
					for(t2 = 0; t2 < sx; t2++)
					{
			            lcd_write_data(fcol >> 8);
			            lcd_write_data(fcol);
			        }    
			    }
	   	        else	
		        {
					for(t2 = 0; t2 < sx; t2++)
					{
			            lcd_write_data(bcol >> 8);
			            lcd_write_data(bcol);
			        }    
			    }   
		    }
	    }	
	}
}	

//Print one \0 terminated string to given coordinates to the screen
//xf and yf define "stretch factor"
void lcd_putstring(int x0, int y0, char *s, unsigned int fcol, unsigned int bcol, int xf, int yf)
{
	int x = 0;
	
	while(*s)
	{
		lcd_putchar(x + x0, y0, *(s++), fcol, bcol, xf, yf);
		x += (FONTWIDTH * xf);
	}	
}


//Print a number
//xf and yf define "stretch factor"
int lcd_putnumber(int col, int row, long num, int dec, int fcolor, int bcolor, int xf, int yf)
{
    char *s = (char*) malloc(16);
    int slen = 0;
	if(s != NULL)
	{
	    int2asc(num, dec, s, 16);
	    lcd_putstring(col, row, s, fcolor, bcolor, xf, yf);
	    slen = strlen(s);
	    free(s);
	}	
	return slen;
}

//////////////////////
// STRING FUNCTIONS //
//////////////////////
//INT 2 ASC: Put a number to the screen (with decimal separator if needed)
int int2asc(long num, int dec, char *buf, int buflen)
{
    int i, c, xp = 0, neg = 0;
    long n, dd = 1E09;

    if(!num)
	{
	    *buf++ = '0';
		*buf = 0;
		return 1;
	}	
		
    if(num < 0)
    {
     	neg = 1;
	    n = num * -1;
    }
    else
    {
	    n = num;
    }

    //Fill buffer with \0
    for(i = 0; i < buflen; i++)
    {
	    *(buf + i) = 0;
    }

    c = 9; //Max. number of displayable digits
    while(dd)
    {
	    i = n / dd;
	    n = n - i * dd;
	
	    *(buf + 9 - c + xp) = i + 48;
	    dd /= 10;
	    if(c == dec && dec)
	    {
	        *(buf + 9 - c + ++xp) = '.';
	    }
	    c--;
    }

    //Search for 1st char different from '0'
    i = 0;
    while(*(buf + i) == 48)
    {
	    *(buf + i++) = 32;
    }

    //Add minus-sign if neccessary
    if(neg)
    {
	    *(buf + --i) = '-';
    }

    //Eleminate leading spaces
    c = 0;
    while(*(buf + i))
    {
	    *(buf + c++) = *(buf + i++);
    }
    *(buf + c) = 0;
	
	return c;
}

//STRLEN
int strlen(char *s)
{
   int t1 = 0;

   while(*(s + t1++));

   return (t1 - 1);
}

int main(void)
{
   
    int bgcolor = BLACK;
    
    //Turn on the GPIOA peripheral for DDS
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOAEN; //RCC->AHB1ENR |= (1<<0);
    
    //LCD
    //Put pin 0..4 in general purpose output mode
    LCD_GPIO->MODER |= (1 << (DATA << 1));	
    LCD_GPIO->MODER |= (1 << (CLK << 1));	
    LCD_GPIO->MODER |= (1 << (DC_AO << 1));	
    LCD_GPIO->MODER |= (1 << (RST << 1));	
    LCD_GPIO->MODER |= (1 << (CS << 1));	
    LCD_GPIO->ODR = 0;
    
    //LED
    LCD_GPIO->MODER |= (1 << (6 << 1));	
    LCD_GPIO->MODER |= (1 << (7 << 1));
    	
    //Start ST7735 LCD
    lcd_reset();
    delay(100);
    lcd_init();
    lcd_cls0(BLACK);
    
    //Display data on screen 
    /*lcd_putstring(4, 3, "LCD ST7735 DEMO", LIGHTRED, bgcolor, 1, 1);    
    lcd_putnumber(46, 16, 20191, 1, WHITE, bgcolor, 1, 1);
    
    lcd_putstring(5, 30, "Font 1x1", LIGHTGREEN, DARKBLUE, 1, 1);
    lcd_putstring(5, 45, "2x1", LIGHTYELLOW, DARKBLUE, 2, 1);
    lcd_putstring(80, 35, "1x2", LIGHTRED, DARKBLUE, 1, 2);
    lcd_putstring(5, 60, "2x2",  WHITE, DARKBLUE, 2, 2);
    lcd_putstring(5, 80, "3x3",   LIGHTBLUE, DARKBLUE, 3, 3);
    lcd_putstring(72, 54, "2x3",   LIGHTVIOLET, DARKBLUE, 2, 3);
    lcd_putstring(77, 95, "DK7IH",  WHITE, DARKBLUE, 1, 1);
    */
    lcd_putstring(0, 0 * FONTHEIGHT, (char*)"ABCDEFGHIJK", LIGHTRED, bgcolor, 1, 1);    
    lcd_putstring(0, 1 * FONTHEIGHT, (char*)"LMNOPQRSTUV", LIGHTGREEN, bgcolor, 1, 1);    
    lcd_putstring(0, 2 * FONTHEIGHT, (char*)"XYZ!%&/()=?", LIGHTBLUE, bgcolor, 1, 1);    
    lcd_putstring(0, 3 * FONTHEIGHT, (char*)"1234567890", LIGHTBLUE, bgcolor, 1, 1);    
    lcd_putstring(0, 4 * FONTHEIGHT, (char*)",;.:-_#*+-", YELLOW, bgcolor, 1, 1);    
    for(;;) 
	{
		
	}
	return 0;
}
